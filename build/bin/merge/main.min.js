var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b};$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.inherits=function(a,b){a.prototype=$jscomp.objectCreate(b.prototype);a.prototype.constructor=a;if($jscomp.setPrototypeOf){var c=$jscomp.setPrototypeOf;c(a,b)}else for(c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.superClass_=b.prototype};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,f=0;f<d;f++){var e=a[f];if(b.call(c,e,f,a))return{i:f,v:e}}return{i:-1,v:void 0}};$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in c||(c[f]={});c=c[f]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");
var Common=function(){var a="B KB MB GB TB PB EB ZB YB".split(" ");return{renderSize:function(b){if(null==b||""==b)return"0 Bytes";var c=parseFloat(b);b=Math.floor(Math.log(c)/Math.log(1024));c/=Math.pow(1024,b);c=c.toFixed(2);return c+a[b]},removePostfix:function(a){var b=a.lastIndexOf(".");0<b&&(a=a.substring(0,b));return a},initTooltip:function(){$('[data-toggle="tooltip"]').tooltip()},writeCookie:function(a,c){$.cookie(a,c,{expires:9999})},cookieIfPresent:function(a,c){(a=$.cookie(a))&&c(a)},
render:function(a,c){a.content||(a.content=$(a.name).html().trim(),Mustache.parse(a.content));return Mustache.render(a.content,c)},ts:function(){return Math.round((new Date).getTime()/1E3).toString()}}}();$(function(){$.cookie.json=!0;toastr.options.closeButton=!0;Common.initTooltip()});
var ChatServerArray=[{name:"bilibili",value:"chat.bilibili.com"},{name:"\u4f18\u9177",value:"service.danmu.youku.com"},{name:"\u7231\u5947\u827a",value:"cmts.iqiyi.com"},{name:"\u817e\u8baf",value:"mfm.video.qq.com"},{name:"\u7b2c\u4e00\u5f39",value:"api.diyidan.net"},{name:"\u52a8\u753b\u75af",value:"ani.gamer.com.tw"},{name:"AcFun",value:"danmu.aixifan.com"},{name:"\u641c\u72d0",value:"api.danmu.tv.sohu.com"}],ENUM_TASK_STATE={WAIT_PARSE:0,WAIT_HANDLE:1,HANDLEING:2,HANDLE_SUCCESS:3,HANDLE_FAIL:-1,
PARSE_FAIL:-2},TaskStateResolver={parse:function(a){if(a==ENUM_TASK_STATE.WAIT_PARSE)a="\u5f85\u89e3\u6790";else if(a==ENUM_TASK_STATE.WAIT_HANDLE)a="\u5f85\u5904\u7406";else if(a==ENUM_TASK_STATE.HANDLEING)a="\u5904\u7406\u4e2d";else if(a==ENUM_TASK_STATE.HANDLE_SUCCESS)a="\u5904\u7406\u5b8c\u6210";else if(a==ENUM_TASK_STATE.HANDLE_FAIL)a="\u5904\u7406\u5931\u8d25";else if(a==ENUM_TASK_STATE.PARSE_FAIL)a="\u89e3\u6790\u5931\u8d25";else throw Error("\u672a\u77e5\u7684\u4efb\u52a1\u72b6\u6001\uff1a"+
a);return a}},ItemOriginResolver={resolve:function(a){var b="\u672a\u77e5";if(void 0==a)b="-";else for(var c=$jscomp.makeIterator(ChatServerArray),d=c.next();!d.done;d=c.next())if(d=d.value,d.value==a){b=d.name;break}return b}},ToolbarTable=function(a){this.$table=$("#"+a+" .table");this.$table.bootstrapTable("refreshOptions",{locale:"zh-CN"});this.$add=$("#"+a+" .file-input");this.$remove=$("#"+a+" .btn-remove");this.$clear=$("#"+a+" .btn-clear");this.initToolbar()};
ToolbarTable.prototype.initToolbar=function(){var a=this;this.$add.on("change",function(b){a.resolve(b.target.files);a.$add.val(null)});this.$table.on("check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table",function(b){b=0==a.$table.bootstrapTable("getSelections").length;a.$remove.attr("disabled",b)});this.$table.on("reset-view.bs.table",function(){var b=0==a.getValidData().length;a.$clear.attr("disabled",b);if(a.onEmptyListener)a.onEmptyListener(b)});this.$clear.click(function(){return a.$table.bootstrapTable("removeAll")});
this.$remove.click(function(){for(var b=a.$table.bootstrapTable("getSelections"),c=0;c<b.length;c++)a.$table.bootstrapTable("removeByUniqueId",b[c].name);a.$remove.attr("disabled",!0)})};ToolbarTable.prototype.getValidData=function(){return this.$table.bootstrapTable("getData").filter(function(a){a=a.state;return a==ENUM_TASK_STATE.WAIT_HANDLE||a==ENUM_TASK_STATE.HANDLE_SUCCESS||a==ENUM_TASK_STATE.HANDLE_FAIL})};
ToolbarTable.prototype.addIfAbsent=function(a){if(null==this.$table.bootstrapTable("getRowByUniqueId",a.name)){var b=[];b.push(a);this.$table.bootstrapTable("append",b)}else toastr.warning("\u6587\u4ef6\uff1a"+a.name+"\uff0c\u5df2\u5728\u8868\u683c\u4e2d\uff01")};ToolbarTable.prototype.resolve=function(a){throw Error("this method has not been implemented.");};ToolbarTable.prototype.updateData=function(a){this.$table.bootstrapTable("updateByUniqueId",{id:a.name,row:a})};
var TableItem=function(a){this.file=a;this.name=Common.removePostfix(a.name);this.length=a.size;this.state=ENUM_TASK_STATE.WAIT_PARSE},ModalDrag=function(a){this.$modal=$("#modal-drag");this.initDrag(a)};
ModalDrag.prototype.initDrag=function(a){var b=this,c=this.$modal.find(".modal-content");this.enterH1=!1;var d=c.find("h1");d.on("dragenter",function(){b.enterH1=!0;return!1});d.on("dragleave",function(){return b.enterH1=!1});c.on("dragenter",function(){c.css("opacity",1);return!1});c.on("dragleave",function(){b.enterH1||c.css("opacity",.5);return!1});c.on("dragover",function(){return!1});c.on("drop",function(d){a(d.originalEvent.dataTransfer.files);b.$modal.modal("hide");b.enterH1=!1;c.css("opacity",
.5);return!1});$("body").on("dragenter",function(){b.$modal.modal("show");return!1});this.$modal.on("dragenter",function(){return!1});this.$modal.on("dragleave",function(){1!=parseInt(c.css("opacity"))&&b.$modal.modal("hide");return!1});this.$modal.on("dragover",function(){return!1});this.$modal.on("drop",function(){b.$modal.modal("hide");return!1})};
var DragTableHelper=function(){function a(a){return!a.find("span").hasClass("d-none")}return{fixTableHeight:function(a){var b=a.parents(".fixed-table-container");a.on("post-header.bs.table page-change.bs.table reset-view.bs.table",function(){b.height(a.height()-35)})},initExecute:function(a,c){function b(){g.attr("disabled",!1);e.addClass("d-none")}var f=$("#btn-execute"),e=f.find("span"),g=$("#form-"+a);f.click(function(){g.attr("disabled",!0);e.removeClass("d-none");c(b)});return f},bindToolbarTableAndExecute:function(a,
c){a.onEmptyListener=function(a){return c.attr("disabled",a)}},isExecuting:a,initModalDrag:function(b,c){new ModalDrag(function(d){a(b)?toastr.warning("\u6267\u884c\u4e2d\uff0c\u65e0\u6cd5\u6dfb\u52a0\u6587\u4ef6\uff01"):c(d)})}}}(),DanMuHandler=function(){var a={name:"#template-danmu"};return{resolveFiles:function(a,c,d){function b(a,b){var c=b.find("chatserver:first").text();b=b.find("d");a.origin=c;a.num=b.length;a.state=ENUM_TASK_STATE.WAIT_HANDLE}a=$jscomp.makeIterator(a);for(var e=a.next();!e.done;e=
a.next())e=e.value,"text/xml"!=e.type?toastr.error("\u6587\u4ef6\uff1a"+e.name+"\uff0c\u4e0d\u662f\u4e00\u4e2a\u5f39\u5e55\u6587\u4ef6\uff01"):(e=new TableItem(e),c(e),DanMuHandler.read(e,b,d))},read:function(a,c,d){var b=new FileReader;b.onload=function(){try{var b=$($.parseXML(this.result))}catch(g){console.error(g);toastr.error("\u6587\u4ef6\uff1a"+a.name+"\uff0c\u975e\u6807\u51c6\u5f39\u5e55XML\uff01");a.state=ENUM_TASK_STATE.PARSE_FAIL;d(a);return}c(a,b);d(a)};b.readAsText(a.file,"UTF-8")},parseDanMu:function(a,
c){var b=c.find("chatid:first").text();c=c.find("d").map(function(a,b){a=$(b);b=a.attr("p").split(",");return new DanMuItem(a.text().trim(),b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7])}).toArray();return new DanMu(a.origin,b,c)},render:function(b){return Common.render(a,b)}}}(),DanMuTable=function(){ToolbarTable.apply(this,arguments)};$jscomp.inherits(DanMuTable,ToolbarTable);
DanMuTable.prototype.resolve=function(a){var b=this.addIfAbsent.bind(this),c=this.updateData.bind(this);DanMuHandler.resolveFiles(a,b,c)};var DanMu=function(a,b,c){this.chatServer=a;this.chatId=b;this.items=c},DanMuItem=function(a,b,c,d,f,e,g,h,k){this.content=a;this.playTime=parseFloat(b);this.type=parseInt(c);this.size=parseInt(d);this.color=parseInt(f);this.createTime=e;this.pool=g;this.uid=h;this.historyId=k};
$jscomp.global.Object.defineProperties(DanMuItem,{defaultSize:{configurable:!0,enumerable:!0,get:function(){return 25}},defaultColor:{configurable:!0,enumerable:!0,get:function(){return 16777215}}});
var AppendStrategy={name:"\u8ffd\u52a0\u5f0f",get:function(a,b,c){a=b.map(function(a){return a.playTime});return Math.max.apply(null,a)}},SuperpositionStrategy={name:"\u53e0\u52a0\u5f0f",get:function(a,b,c){return 0}},MergeOption=function(a){this.strategy=DanMuMerger.parseStrategy(a)},DanMuMerger=function(){function a(c,f,e,g,h,k){DanMuHandler.read(c[g],function(d,l){d.state=ENUM_TASK_STATE.HANDLEING;h(d);try{e=b(c,f,e,g,d,l)}catch(m){console.log(m);toastr.error(d.name+"\uff0c\u6587\u4ef6\u5904\u7406\u5931\u8d25\uff01");
k();return}d.state=ENUM_TASK_STATE.HANDLE_SUCCESS;h(d);g++;g==c.length?(d=DanMuHandler.render(e),d=new Blob([d],{type:"text/plain;charset=utf-8"}),l=Common.ts(),saveAs(d,"\u5f39\u5e55\u5408\u5e76["+c.length+"\u00b7"+f.strategy.name+"]("+l+").xml"),k()):a(c,f,e,g,h,k)},h)}function b(a,b,c,g,h,k){h=DanMuHandler.parseDanMu(h,k);if(!c)return h;a=b.strategy.get(a,c.items,g);var d=Math.round(1E3*a);h.items.forEach(function(a){a.playTime=(Math.round(1E3*a.playTime)+d)/1E3});c.items=c.items.concat(h.items);
return c}var c=[AppendStrategy,SuperpositionStrategy];return{parseStrategy:function(a){return c[a]},merge:function(b,c,e,g){toastr.info("\u5408\u5e76\u8fdb\u884c\u4e2d\uff0c\u8bf7\u7a0d\u5019...");a(b,c,null,0,e,g)}}}();
$(function(){var a=new DanMuTable("form-merge"),b=a.updateData.bind(a),c=DragTableHelper.initExecute("merge",function(c){var d=a.getValidData();if(2>d.length)toastr.warning("\u6709\u6548\u5f85\u5408\u5e76\u5f39\u5e55\u6587\u4ef6\u6570\u5c11\u4e8e2\u4e2a\uff01"),c();else{var e=$('input:radio[name="mergeStrategy"]:checked').val(),g=new MergeOption(e);Common.writeCookie("merge",{strategy:e});DanMuMerger.merge(d,g,b,c)}});DragTableHelper.bindToolbarTableAndExecute(a,c);DragTableHelper.initModalDrag(c,
function(b){return a.resolve(b)});Common.cookieIfPresent("merge",function(a){$("input:radio[name=mergeStrategy][value='"+a.strategy+"']").attr("checked",!0)})});
